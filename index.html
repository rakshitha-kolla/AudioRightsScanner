<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Audio Copyright Detector</title>
   <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="app">
        <header>
            <div class="header-content">
                <div class="logo">üéµ Audio Copyright Detector</div>
                <div class="tagline">Detect copyrighted music using ACRCloud API</div>
            </div>
        </header>

        <div class="container">
            <div class="main-grid">
                <!-- Upload Section -->
                <div class="card">
                    <h2>üìÅ Select Audio File</h2>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">‚Üì</div>
                        <p><strong>Drag & Drop</strong> your audio file here</p>
                        <p style="font-size: 12px; color: var(--text-secondary);">or click to browse</p>
                        <input type="file" id="fileInput" accept="audio/*">
                        <div class="file-name" id="fileName"></div>
                    </div>
                </div>

                <!-- API Config Section -->
                <div class="card">
                    <h2>‚öôÔ∏è Configuration</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; text-transform: uppercase;">API Status</label>
                        <button class="btn-secondary" id="healthBtn" style="width: 100%;">
                            Check Health
                        </button>
                    </div>
                    <div id="healthStatus"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button class="btn-primary" id="detectBtn">üîç Detect Copyright</button>
                <button class="btn-secondary" id="resetBtn">üîÑ Reset</button>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <h3 style="margin-bottom: 20px; font-size: 20px;">Detection Results</h3>
                <div id="results">
                    <div class="empty-state">
                        <div class="empty-icon">üéß</div>
                        <p>Select an audio file and click "Detect Copyright" to begin</p>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="statProcessed">0</div>
                    <div class="stat-label">Files Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statCopyrighted">0</div>
                    <div class="stat-label">Copyrighted Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statSuccess">0%</div>
                    <div class="stat-label">Detection Rate</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let selectedFile = null;
        let stats = { processed: 0, copyrighted: 0 };

        // Upload Zone
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file) return;
            if (!file.type.startsWith('audio/')) {
                alert('Please select an audio file');
                return;
            }
            selectedFile = file;
            document.getElementById('fileName').textContent = `‚úì ${file.name}`;
        }

        // Health Check
        document.getElementById('healthBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                const data = await response.json();
                document.getElementById('healthStatus').innerHTML = `
                    <div class="alert alert-success">
                        ‚úì API is healthy
                    </div>
                `;
            } catch (error) {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="alert alert-error">
                        ‚úó Cannot connect to API
                    </div>
                `;
            }
        });

        // Detect
        document.getElementById('detectBtn').addEventListener('click', async () => {
            if (!selectedFile) {
                alert('Please select an audio file');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <div class="loading-spinner"></div>
                    <span>Analyzing audio...</span>
                </div>
            `;

            try {
                const formData = new FormData();
                formData.append('audio_file', selectedFile);

                const response = await fetch(`${API_URL}/api/detect`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                displayResults(data);
                updateStats(data);
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-error">
                        ‚úó Error: ${error.message}
                    </div>
                `;
            }
        });

        // Reset
        document.getElementById('resetBtn').addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            document.getElementById('fileName').textContent = '';
            document.getElementById('results').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üéß</div>
                    <p>Select an audio file and click "Detect Copyright" to begin</p>
                </div>
            `;
        });
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            let html = '';

            if (data.copyrighted === true && data.segments?.length > 0) {
                html = `
                    <div class="status-badge status-found">
                        ‚úì Copyrighted Music Detected
                    </div>
                `;

                data.segments.forEach(seg => {
                    const music = seg.music || {};

                    html += `
                        <div class="match-card">
                            <div class="match-title">${music.title || 'Unknown'}</div>
                            <div class="match-artist">${music.artist || 'Unknown'}</div>
                            <div class="match-details">
                                <div class="detail">
                                    <span class="detail-label">Start</span>
                                    <span class="detail-value">${seg.start.toFixed(2)}s</span>
                                </div>
                                <div class="detail">
                                    <span class="detail-label">End</span>
                                    <span class="detail-value">${seg.end.toFixed(2)}s</span>
                                </div>
                                <div class="detail">
                                    <span class="detail-label">Duration</span>
                                    <span class="detail-value">${seg.duration.toFixed(2)}s</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

            } else if (data.copyrighted === false) {
                html = `
                    <div class="status-badge status-not-found">
                        ‚úó No Copyrighted Music
                    </div>
                    <div style="padding: 20px; text-align: center;">
                        Safe to use!
                    </div>
                `;
            } else if (data.error) {
                html = `
                    <div class="status-badge status-error">
                        ‚úó Error
                    </div>
                    <div class="alert alert-error">
                        ${data.error}
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        function updateStats(data) {
            stats.processed++;
            if (data.copyrighted === true) {
                stats.copyrighted++;
            }

            document.getElementById('statProcessed').textContent = stats.processed;
            document.getElementById('statCopyrighted').textContent = stats.copyrighted;
            document.getElementById('statSuccess').textContent = 
                Math.round((stats.copyrighted / stats.processed) * 100) + '%';

            document.getElementById('statsGrid').style.display = 'grid';
        }

        // Auto-check health on load
        window.addEventListener('load', async () => {
            document.getElementById('healthBtn').click();
        });
    </script>
</body>
</html>