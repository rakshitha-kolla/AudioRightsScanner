<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Copyright Detector</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="app">
        <header>
            <div class="header-content">
                <div class="logo">Audio Copyright Detector</div>
                <div class="tagline">Detect copyrighted music using ACRCloud API</div>
            </div>
        </header>

        <div class="container">
            <div>
                <div class="card">
                    <h2>Select Audio File</h2>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">â†“</div>
                        <p><strong>Drag & Drop</strong> your audio file here</p>
                        <p style="font-size: 12px; color: var(--text-secondary);">or click to browse</p>
                        <input type="file" id="fileInput" accept="audio/*">
                        <div class="file-name" id="fileName"></div>
                    </div>
                </div>

            <div class="button-group">
                <button class="btn-primary" id="detectBtn">Detect Copyright</button>
                <button class="btn-primary" id="resetBtn">Reset</button>
            </div>

            <div class="results-section">
                <h3 style="margin-bottom: 20px; font-size: 20px;">Detection Results</h3>
                <div id="results">
                    <div class="empty-state">
                        <div class="empty-icon">ðŸŽ§</div>
                        <p>Select an audio file and click "Detect Copyright" to begin</p>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="statProcessed">0</div>
                    <div class="stat-label">Files Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statCopyrighted">0</div>
                    <div class="stat-label">Copyrighted Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statSuccess">0%</div>
                    <div class="stat-label">Detection Rate</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://audiorightsscanner.onrender.com";
        let selectedFile = null;
        let stats = { processed: 0, copyrighted: 0 };

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => { e.preventDefault(); uploadZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (!file) return;
            if (!file.type.startsWith('audio/')) { alert('Please select an audio file'); return; }
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
        }

        document.getElementById('healthBtn').addEventListener('click', async () => {
            try {
                await fetch(`${API_URL}/api/health`);
                document.getElementById('healthStatus').innerHTML = '<div class="alert alert-success">API is healthy</div>';
            } catch {
                document.getElementById('healthStatus').innerHTML = '<div class="alert alert-error">Cannot connect to API</div>';
            }
        });

        document.getElementById('detectBtn').addEventListener('click', async () => {
            if (!selectedFile) { alert('Please select an audio file'); return; }

            const resultsDiv = document.getElementById('results');

            const setStatus = (msg) => {
                resultsDiv.innerHTML = `
                    <div class="alert alert-success" style="display:flex;align-items:center;gap:12px;">
                        <div class="loading-spinner"></div>
                        <span>${msg}</span>
                    </div>`;
            };

            setStatus('Uploading audio file...');

            try {
                const formData = new FormData();
                formData.append('audio_file', selectedFile);

                const uploadRes = await fetch(`${API_URL}/api/detect`, { method: 'POST', body: formData });
                const uploadData = await uploadRes.json();

                console.log('Upload response:', uploadData);

                if (!uploadData.job_id) {
                    displayResults(uploadData);
                    updateStats(uploadData);
                    return;
                }

                const job_id = uploadData.job_id;
                setStatus('Analyzing audio... this may take 1-2 minutes.');

                let data = null;
                let attempts = 0;
                const maxAttempts = 120;

                while (attempts < maxAttempts) {
                    await new Promise(r => setTimeout(r, 2000));
                    attempts++;

                    const statusRes = await fetch(`${API_URL}/api/detect/status/${job_id}`);
                    const statusData = await statusRes.json();

                    console.log(`Poll ${attempts}:`, statusData);

                    if (statusData.status === 'done') {
                        data = statusData.result;
                        break;
                    } else if (statusData.status === 'error') {
                        throw new Error(statusData.error || 'Detection failed');
                    } else {
                        setStatus(`Analyzing audio... (${attempts * 2}s elapsed)`);
                    }
                }

                if (!data) throw new Error('Detection timed out. Try a shorter file.');

                displayResults(data);
                updateStats(data);

            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            document.getElementById('fileName').textContent = '';
            document.getElementById('results').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ðŸŽ§</div>
                    <p>Select an audio file and click "Detect Copyright" to begin</p>
                </div>`;
        });

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            console.log('Displaying results:', data);
            let html = '';

            if (data.copyrighted === true && data.segments && data.segments.length > 0) {
                html = '<div class="status-badge status-found">Copyrighted Music Detected</div>';
                data.segments.forEach(seg => {
                    const music = seg.music || {};
                    html += `
                        <div class="match-card">
                            <div class="match-title">${music.title || 'Unknown'}</div>
                            <div class="match-artist">${music.artist || 'Unknown'}</div>
                            <div class="match-details">
                                <div class="detail"><span class="detail-label">Start</span><span class="detail-value">${seg.start.toFixed(2)}s</span></div>
                                <div class="detail"><span class="detail-label">End</span><span class="detail-value">${seg.end.toFixed(2)}s</span></div>
                                <div class="detail"><span class="detail-label">Duration</span><span class="detail-value">${seg.duration.toFixed(2)}s</span></div>
                            </div>
                        </div>`;
                });
            } else if (data.copyrighted === false) {
                html = `
                    <div class="status-badge status-not-found">No Copyrighted Music</div>
                    <div style="padding: 20px; text-align: center;">Safe to use!</div>`;
            } else if (data.error) {
                html = `
                    <div class="status-badge status-error">Error</div>
                    <div class="alert alert-error">${data.error}</div>`;
            } else {
                html = `<div class="alert alert-error">Unexpected response: ${JSON.stringify(data)}</div>`;
            }

            resultsDiv.innerHTML = html;
        }

        function updateStats(data) {
            stats.processed++;
            if (data.copyrighted === true) stats.copyrighted++;
            document.getElementById('statProcessed').textContent = stats.processed;
            document.getElementById('statCopyrighted').textContent = stats.copyrighted;
            document.getElementById('statSuccess').textContent = Math.round((stats.copyrighted / stats.processed) * 100) + '%';
            document.getElementById('statsGrid').style.display = 'grid';
        }

        window.addEventListener('load', () => document.getElementById('healthBtn').click());
    </script>
</body>
</html>